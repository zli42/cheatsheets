# Statistics

## 大样本 小样本

大样本、小样本并不是以样本量大小来区分的。

* 大样本：在样本量 $ n \rightarrow \infty$ 的条件下进行的统计推断、问题分析，成为大样本问题。
* 小样本：在样本量固定的条件下进行的统计推断、问题分析，不管样本量多大，都称为小样本问题。

一般，统计学中 $ n \geq 30 $ 为大样本，$ n < 30 $ 为小样本，这只是一种经验说法。

## 正态分布

若连续型随机变量 $X$ 的概率密度为
$$f(x) = \frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(x-\mu)^2}{2\sigma^2}}, -\infty < x < +\infty$$
其中，$\mu$ 为均值，$\sigma (\sigma>0)$ 为标准差，则称 $X$ 服从正态分布，记为 $X \sim N(\mu, \sigma^2)$。

若 $X \sim N(\mu, \sigma^2)$, 则 $X=\frac{X-\mu}{\sigma} \sim N(0, 1)$。该分布为标准正态分布，也成为 Z 分布。

## $\chi^2$ 分布

若 $X_1, X_2, \cdots, X_n$ 相互独立，且都服从标准正态分布 $N(0, 1)$，则称随机变量 $Y=X_1^2+X_2^2+\cdots+X_n^2$ 服从自由度为 $n$ 的 $\chi^2$ 分布，记为 $Y \sim \chi^2(n)$。

$\chi^2$分布可加性：若 $Y_1 \sim \chi^2(n_1)$，$Y_2 \sim \chi^2(n_2)$，且 $Y_1$ 与 $Y_2$ 相互独立，则 $Y_1+Y_2 \sim \chi^2(n_1+n_2)$。

## t 分布

若 $X \sim N(0， 1)$，$Y \sim \chi^2(n)$，且 $X$ 与 $Y$ 相互独立，则称 $T=\frac{X}{\sqrt{Y/n}}$ 服从自由度为 $n$ 的 t 分布，记为 $T \sim t(n)$。

当 $n$ 很大时（$n\geq30$），$t(n)$ 分布趋近于标准正态分布 $N(0, 1)$（Z 分布）。

## 中心极限定理

从任何独立、同分布的总体（均值为 $\mu$，方差为 $\sigma^2$）中抽取样本容量为 $n$ 的样本，当 $n$ 足够大时，样本均值的抽样分布服从于均值为 $\mu$，方差为 $\sigma^2/n$ 的正态分布。

故当样本足够大，样本均值服从正态分布。

## 假设检验

### 原假设 备选假设

* 原假设：对总体参数的某种假设（例如：实验组、对照组无差异），记为 $H_0$。
* 备选假设：对总体参数的另一种假设（例如：实验组、对照组有差异），对立于原假设，记为 $H_1$。

### 第 I 类错误 第 II 类错误

#### 第 I 类错误

若 $H_0$ 实际为真时，拒绝了 $H_0$ 假设，称为第 I 类错误。例如，实际上实验组相对对照组无效，但是显示实验组有效。

犯第 I 类错误的概率表示为 $\alpha$，通常取 $\alpha=0.05$。

减少第 I 类错误：提高置信水平。

#### 第 II 类错误

若 $H_0$ 实际为假时，接受了 $H_0$ 假设，称为第 II 类错误。例如，实际上实验组相对对照组有效，但是显示实验组无效。

犯第 II 类错误的概率表示为 $\beta$，通常取 $\beta < 0.2$。

减少第 II 类错误：提高统计功效。

|||决策||
|--|--|--|--|
|||接受 $H_0$|拒绝 $H_0$|
|实际|$H_0$ 为真|$1-\alpha$ 置信水平|$\alpha$ 显著性水平
||$H_0$ 为假|$\beta$|$1-\beta$ 统计功效

* 当样本量固定时，不能同时减少犯两类错误的概率。通常选择一个较小的显著性水平 $\alpha$。
* 当样本量不固定时，增加样本量，可以同时减少犯两类错误的概率。

### p-value (probality value)

p-value 表示在观测数据下，随机因素产生差异的概率，也表示拒绝原假设的最小显著性水平，犯第 I 类错误的最小概率。

* $p \leq \alpha$，拒绝原假设 $H_0$。
* $p > \alpha$，接受原假设 $H_0$。


## T 显著性检验

T 检验是通过比较不同数据的均值，研究两组数据之间是否存在显著差异。

前提：

1. 独立
2. 近似正态分布
3. 有相似的方差

使用 A 方案人数 $N_a$，使用 B 方案人数 $N_b$。

由样本计算出，A 方案的 CTR 为 $\hat{P_a}$，B 方案的 CTR 为 $\hat{P_b}$。分别以 $\hat{P_a}$ 和 $\hat{P_b}$ 来估算 $P_a$ 和 $P_b$。用户点击服从期望为 $P$ 的二项分布，根据中心极限定理，当 A、B 方案样本足够大时，样本均值服从正态分布。

* 原假设：差异不显著 $H_0:X=P_b-P_a\le0$
* 备选假设：差异显著 $H_1:X=P_b-P_a\gt0$

由于总体方差未知，根据原假设构建 t 检验统计量：

$$t=\frac{(\hat{P_b}-\hat{P_a})-(P_b-P_a)}{\sqrt{\frac{\hat{P_b}(1-\hat{P_b})}{N_b}+\frac{\hat{P_a}(1-\hat{P_a})}{N_a}}}$$

根据原假设，仅需验证 $P_b-P_a=0$ 的情况即可。给定显著性水平 $\alpha$（一般 $\alpha=0.05$，即 95% 显著性），$自由度 = 样本数 - 1$，当 $t>t_{\alpha}$ 时，拒绝原假设，差异显著。

* 双侧：不确定是否有差异（更严格）
* 单侧：验证差异是否显著

双侧通过，单侧一定通过；若双侧不通过，单侧通过，则需加大样本量，继续观察。

## Z 检验

推荐系统中，样本量比较大，一般样本量大于 1000，可以使用 Z 检验中的单侧检验（左检验）。

对照组样本数 $n_1$，样本平均 CTR $\bar{p_1}$，实际 CTR $p_1$；
实验组样本数 $n_2$，样本平均 CTR $\bar{p_2}$，实际 CTR $p_2$。

$$ p_1 \sim N(\bar{p_1}, \frac{\bar{p_1}(1-\bar{p_1})}{n_1}) $$
$$ p_2 \sim N(\bar{p_2}, \frac{\bar{p_2}(1-\bar{p_2})}{n_2}) $$
$$ p_1-p_2 \sim N(\bar{p_1}-\bar{p_2}, \frac{\bar{p_1}(1-\bar{p_1})}{n_1}+\frac{\bar{p_2}(1-\bar{p_2})}{n_2}) $$

* 原假设 $H_0: p_1 - p_2 \geq 0$，差异是随机波动引起的
* 对立假设 $H_1: p_1 < p_2$

要拒绝零假设，首先根据观测数据验证 $\bar{p_1} < \bar{p_2}$ 是否成立。如果 $\bar{p_1}$ 和 $\bar{p_2}$ 相差很小，或者 $\bar{p_1}$ 明显大于 $\bar{p_2}$，则无法拒绝原假设；但是如果 $\bar{p_2}$ 比 $\bar{p_1}$ 大很多，那么我们就需要通过 Z 检验来确定有把握拒绝零假设。

$$ Z = \frac{\bar{p_1} - \bar{p_2}}{\sqrt{\frac{\bar{p_1}(1-\bar{p_1})}{n_1}+\frac{\bar{p_2}(1-\bar{p_2})}{n_2}}} $$

其中，$\bar{p_1} - \bar{p_2}$ 是观测到的差异，$\sqrt{\frac{\bar{p_1}(1-\bar{p_1})}{n_1}+\frac{\bar{p_2}(1-\bar{p_2})}{n_2}}$ 是差异的标准差。Z-score 表示观测到的差异有多少个标准误差。

通常取显著性水平 $\alpha=0.05$，即第 I 类错误概率，表示当原假设为真时，拒绝原假设的概率，越小越好。

![zscore_pvalue_normal](https://github.com/zli42/cheatsheets/assets/30396815/1a90f266-e5b0-472d-adf3-d0889abe692b)

当 $\alpha=0.05$ 查标准正态分布表得到临界值 $Z_\alpha=-1.96$，即为 p-value，表示观测到的差异在原假设为真时出现的概率。p-value 越小越不可能观察到，越倾向拒绝原假设。

当 $Z \leq Z_\alpha$，则拒绝原假设，认为实验组与对照组有显著差异，显著性为 $\alpha$；否则无法拒绝原假设。

||双侧检验|左侧检验|右侧检验|
|--|--|--|--|
|假设|$$H_0: p_1 - p_2 = 0$$ $$H_1: p_1 - p_2 \neq 0$$|$$H_0: p_1 - p_2 \geq 0$$ $$H_1: p_1 - p_2 < 0$$|$$H_0: p_1 - p_2 \leq 0$$ $$H_1: p_1 - p_2 > 0$$|
|拒绝域|$\vert Z \vert \geq Z_{1-\frac{\alpha}{2}}$|$Z \leq Z_{1-\alpha}$|$Z \geq Z_{1-\alpha}$|

当双侧检验，即 $H_0: p_1 - p_2 = 0$ 时，
$$ Z = \frac{\bar{p_1} - \bar{p_2}}{\sqrt{\bar{p_0}(1-\bar{p_0})(\frac{1}{n_1}+\frac{1}{n_2})}} $$
其中，$\bar{p_0}=\frac{clk_1+clk_2}{imp_1+imp_2}$，表示两组样本平均 CTR。

## 统计功效

发生第 II 类错误概率为 $\beta$，统计功效 $power=1-\beta$，原假设为假时，拒绝原假设的概率，越大越好。

给定显著水平 $\alpha$ 和统计功效 $1-\beta$，可以估计所需的样本量。

